name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: |
          brew install xcodegen

      - name: Generate Xcode Project
        run: |
          xcodegen generate

      - name: Build App
        run: |
          xcodebuild build \
            -project QuitSmokingDTx.xcodeproj \
            -scheme QuitSmokingDTx \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./DerivedData \
            CODE_SIGNING_ALLOWED=NO

      - name: Archive and Export (Ad-hoc Simulation)
        run: |
          # 因为没有正式证书，我们这里模拟归档并打包产出物
          # 实际生产环境需要配置 Apple Distribution Certificate 和 Provisioning Profile
          xcodebuild archive \
            -project QuitSmokingDTx.xcodeproj \
            -scheme QuitSmokingDTx \
            -archivePath ./build/QuitSmokingDTx.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO
            
          # 将产物压缩为 zip 以便发布
          cd build
          zip -r ../QuitSmokingDTx.zip QuitSmokingDTx.xcarchive

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: QuitSmokingDTx.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
